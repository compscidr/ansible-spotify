---
# Note: We currently use the old .list format because Spotify's package
# creates and expects this format. If Spotify updates to use .sources
# (DEB822) format in the future, we should switch back to using
# deb822_repository module and remove these cleanup tasks. This prevents
# duplicate repository warnings when Spotify auto-updates itself.
- name: Remove old playbook artifacts (new-format sources file)
  tags: spotify
  become: true
  ansible.builtin.file:
    path: /etc/apt/sources.list.d/spotify.sources
    state: absent
- name: Remove old playbook artifacts (old keyring key location)
  tags: spotify
  become: true
  ansible.builtin.file:
    path: /etc/apt/keyrings/spotify.asc
    state: absent

- name: Remove old playbook artifacts (old trusted GPG key)
  tags: spotify
  become: true
  ansible.builtin.file:
    path: /etc/apt/trusted.gpg.d/spotify-C85668DF69375001.gpg
    state: absent

- name: Remove old playbook artifacts (keyring format key)
  tags: spotify
  become: true
  ansible.builtin.file:
    path: /etc/apt/keyrings/spotify.gpg
    state: absent

- name: Ensure gnupg is installed
  tags: spotify
  become: true
  ansible.builtin.apt:
    name: gnupg
    state: present
    update_cache: true

# Note: Spotify's GPG key is provided in ASCII-armored format (text-based)
# despite the .gpg extension in the URL. We convert it to binary format
# using gpg --dearmor and place it in /etc/apt/trusted.gpg.d/ to match
# Spotify's official repository setup without using signed-by.
- name: Ensure /etc/apt/trusted.gpg.d directory exists
  tags: spotify
  become: true
  ansible.builtin.file:
    path: /etc/apt/trusted.gpg.d
    state: directory
    mode: '0755'

- name: Check if Spotify GPG key already exists
  tags: spotify
  become: true
  ansible.builtin.stat:
    path: /etc/apt/trusted.gpg.d/spotify.gpg
  register: spotify_key

- name: Download Spotify GPG key
  tags: spotify
  become: true
  ansible.builtin.get_url:
    url: https://download.spotify.com/debian/pubkey_C85668DF69375001.gpg
    dest: /tmp/spotify.gpg.asc
    mode: '0644'
    # Note: Checksum validation not implemented as Spotify doesn't
    # publish checksums for their GPG keys
  when: not spotify_key.stat.exists

- name: Verify Spotify GPG key fingerprint
  tags: spotify
  become: true
  ansible.builtin.command:
    cmd: gpg --with-colons --import-options show-only --import /tmp/spotify.gpg.asc
  register: spotify_gpg_output
  changed_when: false
  failed_when: "'C85668DF69375001' not in spotify_gpg_output.stdout"
  when: not spotify_key.stat.exists

- name: Dearmor Spotify GPG key to trusted.gpg.d directory
  tags: spotify
  become: true
  ansible.builtin.command:
    cmd: gpg --dearmor -o /etc/apt/trusted.gpg.d/spotify.gpg /tmp/spotify.gpg.asc
    creates: /etc/apt/trusted.gpg.d/spotify.gpg

- name: Remove temporary Spotify GPG key file
  tags: spotify
  become: true
  ansible.builtin.file:
    path: /tmp/spotify.gpg.asc
    state: absent
  when: not spotify_key.stat.exists

- name: Add spotify apt repository
  tags: spotify
  become: true
  ansible.builtin.apt_repository:
    # Note: We place the GPG key in /etc/apt/trusted.gpg.d/ and don't use signed-by
    # to match Spotify's official repository setup. The key is automatically trusted
    # by apt from this location.
    repo: "deb https://repository.spotify.com stable non-free"
    filename: spotify
    state: present
    update_cache: true

- name: Install spotify
  tags: spotify
  become: true
  ansible.builtin.apt:
    name: spotify-client
    state: present
